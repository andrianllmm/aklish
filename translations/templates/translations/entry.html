{% extends 'translations/base.html' %}

{% load humanize %}

{% block content %}
    <div class="container d-flex pb-3 mb-4 border-bottom">
        <div class="me-3 text-center">
            <form action="{% url 'translations:bookmark' entry.pk %}" method="POST">
                {% csrf_token %}
                {% if request.user.is_authenticated and request.user != entry.user %}
                    {% if bookmarked %}
                        <button type="submit" class="btn btn-sm">
                            <i class="bi bi-bookmark-fill text-primary"></i>
                        </button>
                    {% else %}
                        <button type="submit" class="btn btn-sm">
                           <i class="bi bi-bookmark text-primary"></i>
                        </button>
                    {% endif %}
                {% else %}
                    <button type="submit" class="btn btn-sm">
                        <i class="bi bi-bookmark text-secondary"></i>
                    </button>
                {% endif %}
                <div class="my-1">{{ entry.bookmarks.count }}</div>
            </form>
        </div>
        
        <div class="flex-grow-1">
            {{ entry.content|linebreaks }}

            <div class="d-flex align-items-center justify-content-between">
                <div class="me-auto">
                    <small class="me-1"><strong>{{ entry.correctness }}%</strong></small>
                    <span class="badge bg-primary">{{ entry.lang.name }}</span>
                </div>
                <div class="d-flex flex-wrap justify-content-end text-muted">
                    <small class="text-nowrap ms-3">
                    {% if entry.user == request.user %}
                        <a href="{% url 'translations:edit_entry' entry.pk %}">
                            <i class="bi bi-pen"></i>
                        </a>
                    {% else %}
                        <i class="bi bi-pen"></i>
                    {% endif %}
                    </small>
                    <small class="text-nowrap ms-3">
                        by
                        <a href="{% url 'users:profile' entry.user.id entry.user.username %}"
                        class="text-decoration-none">{{ entry.user.username }}</a>
                        <span class="fw-bold">{{ entry.user.profile.reputation }}</span>
                    </small>
                    <small class="text-nowrap ms-3">{{ entry.modified_at|naturaltime }}</small>
                </div>
            </div>
        </div>
    </div>

    <div>
        <h2 class="h5 mb-4">{{ translations_votes|length }} Translations</h2>
        {% for translation, vote in translations_votes %}
            <div class="container d-flex pb-3 mb-4 border-bottom">
                <div class="me-3 text-center">
                    <form action="{% url 'translations:vote' translation.pk %}" method="POST">
                        {% csrf_token %}
                        {% if request.user.is_authenticated and request.user != entry.user %}
                            {% if vote.direction == 1 %}
                                <button type="submit" name="remove" value="1"
                                class="btn btn-sm btn-primary rounded-circle">
                                    <i class="bi bi-caret-up-fill"></i>
                                </button>
                            {% else %}
                                <button type="submit" name="upvote" value="1"
                                class="btn btn-sm btn-outline-primary rounded-circle">
                                    <i class="bi bi-caret-up-fill"></i>
                                </button>
                            {% endif %}
                            <div class="my-1">{{ translation.vote_count }}</div>
                            {% if vote.direction == -1 %}
                                <button type="submit" name="remove" value="-1"
                                class="btn btn-sm btn-primary rounded-circle">
                                    <i class="bi bi-caret-down-fill"></i>
                                </button>
                            {% else %}
                                <button type="submit" name="downvote" value="-1"
                                class="btn btn-sm btn-outline-primary rounded-circle">
                                    <i class="bi bi-caret-down-fill"></i>
                                </button>
                            {% endif %}
                        {% else %}
                            <button type="submit" class="btn btn-sm btn-outline-secondary rounded-circle">
                                <i class="bi bi-caret-up-fill"></i>
                            </button>
                            <div class="my-1">{{ translation.vote_count }}</div>
                            <button type="submit"  class="btn btn-sm btn-outline-secondary rounded-circle">
                                <i class="bi bi-caret-down-fill"></i>
                            </button>
                        {% endif %}
                    </form>
                </div>
                <div class="flex-grow-1">
                    {{ translation.content|linebreaks }}

                    <div class="d-flex align-items-center justify-content-between">
                        <div class="me-auto">
                            <small class="me-1"><strong>{{ translation.correctness }}%</strong></small>
                            <span class="badge bg-primary">{{ translation.lang.name }}</span>
                        </div>
                        <div class="d-flex flex-wrap justify-content-end text-muted">
                            <small class="text-nowrap ms-3">
                            {% if translation.user == request.user %}
                                <a href="{% url 'translations:edit_translation' translation.pk %}">
                                    <i class="bi bi-pen"></i>
                                </a>
                            {% else %}
                                <i class="bi bi-pen"></i>
                            {% endif %}
                            </small>
                            <small class="text-nowrap ms-3">
                                by
                                <a href="{% url 'users:profile' entry.user.id entry.user.username %}"
                                class="text-decoration-none">{{ translation.user.username }}</a>
                                <span class="fw-bold">{{ translation.user.profile.reputation }}</span>
                            </small>
                            <small class="text-nowrap ms-3">{{ translation.modified_at|naturaltime }}</small>
                        </div>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="container pb-3 mb-4 border-bottom">
                No translations
            </div>
        {% endfor %}
    </div>

    <div class="container pb-3 mb-3">
        <h2 class="h5 mb-3">Add translation</h2>
        <form action="{% url 'translations:entry' entry.id %}" method="POST" id="add-translation">
            {% csrf_token %}
            <input type="hidden" name="entry_lang" value="{{ entry.lang.code }}" id="entry_lang">
            <div class="form-group pb-3 mb-3">
                <label for="lang" class="fw-bold mb-2">Language</label>
                <select name="lang" id="lang" class="form-select mb-2">
                    <option value="akl">Aklanon</option>
                    <option value="eng">English</option>
                </select>
                <label for="content" class="fw-bold mb-2">Content</label>
                <div id="proofreader-field"></div>
                <input type="checkbox" name="reverse" id="reverse">
                <label for="reverse">Also add translation as entry</label>
            </div>
            {% if user.is_authenticated %}
                <input type="submit" value="Add Translation" class="btn btn-primary">
            {% else %}
                <a href="{% url 'users:login' %}?next={{ request.path }}"class="btn btn-secondary">
                    Login to add Translation
                </a>
            {% endif %}
        </form>
    </div>

    <script>
        const translationLangSelect = document.querySelector("#lang");
        const entryLang = document.querySelector("#entry_lang");
        console.log(entryLang);

        for (const option of translationLangSelect.options) {
            option.selected = option.value !== entryLang.value;
            option.disabled = option.value === entryLang.value;
        }
    </script>
{% endblock %}